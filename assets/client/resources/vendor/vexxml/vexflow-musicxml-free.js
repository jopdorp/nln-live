/*

 VexFlow VeXML 1.0-pre2
 Created 2012 Daniel Ringwalt <dringw@gmail.com>

 A library for parsing MusicXML in JavaScript to be displayed using VexFlow.

 - Requires jQuery and VexFlow for HTML5 Canvas rendering.
 - Requires Raphael.js for SVG and VML support.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

 Build ID: prod-2@a903988f22d9dbdaa907dc1e08ec0958399c752f
 Build date: 2012-11-24 21:01:36.865809

*/
var a;Vex.Flow.MusicXML={};Vex.ML=Vex.Flow.MusicXML;Vex.ML.Element=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.Element.nodeName=null;Vex.ML.Element.prototype.init=function(c,b){this.options={};Vex.Merge(this.options,b);this.element=c;if(this.nodeName&&this.element.nodeName!=this.nodeName)throw new Vex.Flow.Error('Cannot create "'+this.constructor.name+'" with a "'+this.element.nodeName+'" element.');};Vex.ML.Document=function(c,b){arguments.length>0&&this.init(c,b)};a=Vex.ML.Document.prototype;
a.init=function(c,b){this.options={};Vex.Merge(this.options,b);if(typeof c=="string")if(window.DOMParser&&typeof XMLDocument!="undefined")this.doc=(new window.DOMParser).parseFromString(c,"text/xml");else if(typeof window.ActiveXObject!="undefined"&&new window.ActiveXObject("Microsoft.XMLDOM")){this.doc=new window.ActiveXObject("Microsoft.XMLDOM");this.doc.async="false";this.doc.loadXML(c)}else throw new Error("No XML parser found");else if(c instanceof Document)this.doc=c;else throw new Error("Can't load MusicXML document from a "+
c.constructor.name);this.documentElement=this.doc.documentElement;if(this.documentElement.nodeName!="score-partwise")throw new Error("VeXML only supports partwise scores");this.parts={};this.partGroups={};this.partIDs=[];this.partStaves=[];if(c=this.documentElement.getElementsByTagName("part-list")[0]){b=c.childNodes;var d=null,e=null;for(c=0;c<b.length;c++)if(b[c].tagName=="score-part"){var f=b[c].getAttribute("id");if(f){this.partIDs.push(f);if(d){this.partGroups[f]={};Vex.Merge(this.partGroups[f],
d);if(d.type=="start")d.type="continue"}e=f}}else if(b[c].tagName=="part-group"){var g=b[c];f=parseInt(g.getAttribute("number"));var h=g.getAttribute("type");if(h=="stop"&&e)if(this.partGroups[e].type=="start")delete this.partGroups[e].type;else this.partGroups[e].type="stop";else{var i=g.getElementsByTagName("group-symbol")[0];g=g.getElementsByTagName("group-barline")[0];d={};d.type=h;d.number=f;if(i)d.symbol=i.textContent;if(g)d.symbol=g.textContent}}b=this.documentElement.getElementsByTagName("part");
for(c=0;c<b.length;c++){d=b[c];if(f=d.getAttribute("id")){this.parts[f]=new Vex.ML.Part(d);for(d=0;d<this.partIDs.length;d++)if(this.partIDs[d]==f){this.partStaves[d]=this.getPart(f).getNumberOfStaves();break}}}}};a.serialize=function(){return(new XMLSerializer).serializeToString(this.doc)};a.getPartIDs=function(){return this.partIDs};a.getPart=function(c){var b=this.getPartIDs();c=typeof c=="number"?b[c]:c;if(c in this.parts)return this.parts[c]};
a.getTotalStaves=function(){for(var c=0,b=this.getPartIDs(),d=0;d<b.length;d++)c+=this.partStaves[d];return c};Vex.ML.Part=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.Part.prototype=new Vex.ML.Element;Vex.ML.Part.superclass=Vex.ML.Element;Vex.ML.Part.constructor=Vex.ML.Part;a=Vex.ML.Part.prototype;a.nodeName="part";
a.init=function(c,b){this.constructor.prototype.init.call(this,c,b);this.firstMeasure=null;this.measureElems=[];c=this.element.getElementsByTagName("measure");for(b=0;b<c.length;b++){var d=parseInt(c[b].getAttribute("number"));if(!isNaN(d)){if(this.firstMeasure==null)this.firstMeasure=d;d=d-this.firstMeasure;d in this.measureElems||(this.measureElems[d]=c[b])}}this.attributes=[];this.staves=[];for(b=0;b<this.measureElems.length;b++)if(b in this.measureElems){c=this.measureElems[b].getElementsByTagName("attributes")[0];
if(!c)break;c=c.getElementsByTagName("staves")[0];if(!c)break;c=parseInt(c.textContent);if(!c||isNaN(c)||c==1)break;for(b=1;b<c+1;b++)this.staves[b]=new Vex.ML.PartStaff(this,{staff_num:b});break}};a.getNumberOfMeasures=function(){return this.measureElems.length};
a.getAttributes=function(c,b){if(c in this.attributes)return this.attributes[c];for(var d=undefined,e=0;e<=c;e++)if(e in this.measureElems)if(this.measureElems[e].getElementsByTagName("attributes").length){var f=this.measureElems[e].getElementsByTagName("attributes");b={};if(d)b.previous_attributes=d;for(this.attributes[e]=d=new Vex.ML.Attributes(f[0],b);1<f.length;e++){b={previous_attributes:d};d=new Vex.ML.Attributes(f[1],b)}}else this.attributes[e]=Vex.ML.Attributes.createFromPrevious(d);return this.attributes[c]};
a.getMeasure=function(c,b){if(c in this.measureElems){var d={};if(this.getAttributes(c).getClef())d.clef=this.getAttributes(c).getClef();Vex.Merge(d,b);return new Vex.ML.Measure(this.measureElems[c],d)}};a.getNumberOfStaves=function(){return this.staves.length?this.staves.length-1:1};a.getStaff=function(c){if(!this.staves.length&&c==1)return this;if(!(!c in this.staves))return this.staves[c]};
a.engraveMeasuresOnStaves=function(c,b,d,e){if(!(d instanceof Array)){if(c!=b)throw new Error("Cannot engrave multiple Measures on a single Stave");d=[d]}for(b=0;b<d.length;b++){var f=d[b],g=c+b,h=[],i=[],j=[];if(f instanceof Vex.Flow.Stave)f=[f];for(var l=0;l<f.length;l++){var k=f[l],n=undefined;if(f.length==1)n=this.getMeasure(g);else{n=this.getStaff(l+1);n=n.getMeasure(g)}var o=n.getVoiceNumbers();o.length||(o=[0]);for(var m=0;m<o.length;m++){var p=n.getVoice(o[m]);h.push(p);i.push(p.createVexflowVoice(undefined,
{stave:k}));j.push(k)}k=k.getNoteEndX()-k.getNoteStartX();(new Vex.Flow.Formatter).joinVoices(i).format(i,k);for(m=0;m<h.length;m++)h[m].drawVexflow(undefined,e,j[m]);h=[];j=[]}}};Vex.ML.Attributes=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.Attributes.prototype=new Vex.ML.Element;Vex.ML.Attributes.superclass=Vex.ML.Element;Vex.ML.Attributes.constructor=Vex.ML.Attributes;Vex.ML.Attributes.prototype.nodeName="attributes";
Vex.ML.Attributes.prototype.addAttribute=function(c,b,d){b=this.element.getElementsByTagName(b);if(b.length==1)this.attributes[c]=d(b[0]);else if(b.length==0&&!(c in this.attributes))this.attributes[c]=null;else if(b.length>1){this.attributes[c]=[];for(var e=0;e<b.length;e++){var f=parseInt(b[e].getAttribute("number"));isNaN(f)||(this.attributes[c][f]=d(b[e]))}}};
Vex.ML.Attributes.prototype.init=function(c,b){if(c==undefined){if(false in b)return;this.options={};Vex.Merge(this.options,b)}else if(c.tagName=="attributes")this.constructor.prototype.init.call(this,c,b);else{c=c.getElementsByTagName("attributes");if(!c.length)return;this.constructor.prototype.init.call(this,c[0],b)}this.attributes={};this.new_attributes=[];"previous_attributes"in this.options&&this.options.previous_attributes instanceof Vex.ML.Attributes&&Vex.Merge(this.attributes,this.options.previous_attributes.attributes);
this.addAttribute("clef","clef",Vex.ML.Attributes.Clef);this.addAttribute("time","time",Vex.ML.Attributes.Time);this.addAttribute("key","key",Vex.ML.Attributes.Key);return this};Vex.ML.Attributes.createFromPrevious=function(c){if(!(!c||!("element"in c)||!c.element.ownerDocument)){var b=c.element.ownerDocument;if(b){b=b.createElement("attributes");return new Vex.ML.Attributes(b,{previous_attributes:c})}}};Vex.ML.Attributes.prototype.getAttributes=function(){var c={};Vex.Merge(c,this.attributes);return c};
Vex.ML.Attributes.prototype.getClef=function(){if("clef"in this.attributes)return this.attributes.clef};Vex.ML.Attributes.prototype.getStaveModifiers=function(c){var b={};Vex.Merge(b,c);c=[];if(b.line_start){this.getClef()&&c.push(new Vex.Flow.Clef(this.getClef()));this.attributes.key&&c.push(new Vex.Flow.KeySignature(this.attributes.key.pitch))}b.start_measure&&this.attributes.time&&c.push(new Vex.Flow.TimeSignature(this.attributes.time.symbol));return c};
Vex.ML.Attributes.Clef=function(c){if(c){var b=c.getElementsByTagName("sign")[0];c=c.getElementsByTagName("line")[0];var d;if(b&&c)d=b.textContent+c.textContent;switch(d){case "G2":return"treble";case "F4":return"bass"}}};
Vex.ML.Attributes.Key=function(c){if(c){var b={};if(c=c.getElementsByTagName("fifths")[0]){b.fifths=parseInt(c.textContent);if(!isNaN(b.fifths)){switch(b.fifths){case 0:b.pitch="C";break;case 1:b.pitch="G";break;case 2:b.pitch="D";break;case 3:b.pitch="A";break;case 4:b.pitch="E";break;case 5:b.pitch="B";break;case 6:b.pitch="F#";break;case 7:b.pitch="C#";break;case -1:b.pitch="F";break;case -2:b.pitch="Bb";break;case -3:b.pitch="Eb";break;case -4:b.pitch="Ab";break;case -5:b.pitch="Db";break;case -6:b.pitch=
"Gb";break;case -7:b.pitch="Cb";break}return b}}}};Vex.ML.Attributes.Time=function(c){if(c){var b={},d=c.getElementsByTagName("beats")[0],e=c.getElementsByTagName("beat-type")[0];if(d&&e){d=parseInt(d.textContent);e=parseInt(e.textContent);if(!(isNaN(d)||isNaN(e))){b.num_beats=d;b.beat_value=e;switch(c.getAttribute("symbol")){case "common":b.symbol="C";break;case "cut":b.symbol="C|";break}if(!("symbol"in b))b.symbol=d.toString()+"/"+e.toString();return b}}}};Vex.ML.Measure=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.Measure.prototype=new Vex.ML.Element;Vex.ML.Measure.superclass=Vex.ML.Element;Vex.ML.Measure.constructor=Vex.ML.Measure;a=Vex.ML.Measure.prototype;a.nodeName="measure";
a.init=function(c,b){this.constructor.prototype.init.call(this,c,b);if("clef"in this.options&&this.options.clef)this.clef=this.options.clef;if(c=this.element.getElementsByTagName("attributes")[0]){this.attributes=c;if(c=c.getElementsByTagName("divisions")[0])if(c=parseInt(c.textContent)){this.divisions=c;this.ticksPerDivision=Vex.Flow.RESOLUTION/(4*c);if(!("clef"in this)){c=this.attributes.getElementsByTagName("clef");this.clef=c.length==1?Vex.ML.Attributes.Clef(c[0]):undefined}}}};
a.getStaffNumbers=function(){var c=[],b=this.element.getElementsByTagName("print")[0];if(!b)return[1];b=b.getElementsByTagName("staff-layout");for(var d=0;d<b.length;d++)c.push(parseInt(b[d].getAttribute("number")));c.length||c.push(1);return c};a.getStaff=function(c){return new Vex.ML.PartStaff(this,{staffNum:parseInt(c)})};
a.getVoiceNumbers=function(){var c=[],b=this.element.getElementsByTagName("note"),d=0;a:for(;d<b.length;d++){var e=b[d].getElementsByTagName("voice")[0];if(e){e=parseInt(e.textContent);if(!isNaN(e)){for(var f=0;f<c.length;f++)if(c[f]==e)continue a;c.push(e)}}}return c};a.getVoice=function(c,b){c={voice_num:c};if(this.clef)c.clef=this.clef;Vex.Merge(c,b);return new Vex.ML.Voice(this,c)};
a.getNotes=function(c){var b=[],d=this.element.getElementsByTagName("note"),e={measure:this};Vex.Merge(e,c);for(c=0;c<d.length;c++){var f=new Vex.ML.Note(d[c].cloneNode(true),e);if(f.isRealNote())if(d[c].getElementsByTagName("chord").length==1&&c!=0){var g=b[b.length-1];if(g instanceof Vex.ML.Chord)g.addNote(f);else{g=new Vex.ML.Chord(g);g.addNote(f);b[b.length-1]=g}}else b.push(f)}return b};
a.getStaveModifiers=function(c){var b={};Vex.Merge(b,c);c=[];if(b.line_start){(b=this.attributes.getElementsByTagName("clef")[0])&&c.push(new Vex.Flow.Clef(Vex.ML.Attributes.Clef(b)));(b=this.attributes.getElementsByTagName("key")[0])&&c.push(new Vex.Flow.KeySignature(Vex.ML.Attributes.Key(b).pitch));(b=this.attributes.getElementsByTagName("time")[0])&&c.push(new Vex.Flow.TimeSignature(Vex.ML.Attributes.Time(b).symbol))}return c};Vex.ML.Voice=function(c,b){arguments.length>0&&this.init(c,b)};a=Vex.ML.Voice.prototype;a.init=function(c,b){this.options={};Vex.Merge(this.options,b);if(!("voice_num"in this.options))throw new Error("VeXML.Voice requires a voice_num");this.parentElement=c;this.vexflowVoice=this.vexflowObjects=this.vexflowNotes=undefined};
a.getMeasure=function(c,b){if(!(this.parentElement instanceof Vex.ML.Measure)){if(!("getMeasure"in this.parentElement))return;var d=this.parentElement.getMeasure(c,b);if(!(d.prototype instanceof Vex.ML.Measure))return;return(new Vex.ML.Voice(d,this.options)).getMeasure(c,b)}if(this.options.voice_num==0&&this.parentElement.getVoiceNumbers().length==0)return this.parentElement;c=this.parentElement.element.cloneNode(false);d=this.parentElement.element.childNodes;for(var e=0;e<d.length;e++){var f=d[e];
if(f.tagName=="note"){var g=f.getElementsByTagName("voice")[0];g&&parseInt(g.textContent)==this.options.voice_num&&c.appendChild(f.cloneNode(true))}else c.appendChild(f.cloneNode(true))}d={};Vex.Merge(d,b);return new Vex.ML.Measure(c,d)};
a.createVexflowNotes=function(c){c=this.getMeasure(c).getNotes();this.vexflowNotes=[];this.vexflowObjects=[];this.vexflowVoice=undefined;for(var b=[],d=[],e=0;e<c.length;e++){var f={keys:c[e].getPitches(),duration:c[e].getDuration()};if("clef"in this.options)f.clef=this.options.clef;f=new Vex.Flow.StaveNote(f);if(c[e].numTicks)f.ticks=c[e].numTicks;for(var g=0;g<c[e].numDots;g++)f.addDotToAll();"accidental"in c[e]&&f.addAccidental(0,new Vex.Flow.Accidental(c[e].accidental));this.vexflowNotes.push(f);
if(c[e].beam){g=c[e].beam;if(!g.number||isNaN(g.number))continue;if(g.type=="begin")b[g.number]=[f];else if(g.type=="end"){b[g.number].push(f);this.vexflowObjects.push(new Vex.Flow.Beam(b[g.number]));delete b[g.number]}else if(!g.number in b)continue;else b[g.number].push(f)}if("tieType"in c[e])if(c[e].tieType=="start")d=[f];else{d.push(f);if(c[e].tieType=="stop"){for(f=0;f+1<d.length;f++)this.vexflowObjects.push(new Vex.Flow.StaveTie({first_note:d[f],last_note:d[f+1],first_indices:[0],last_indices:[0]}));
d=[]}}}return this.vexflowNotes};a.createVexflowVoice=function(c,b){this.createVexflowNotes();var d={num_beats:4,beat_value:4,resolution:Vex.Flow.RESOLUTION};c=this.getMeasure(c);if(c.clef)d.clef=c.clef;Vex.Merge(d,b);this.vexflowVoice=new Vex.Flow.Voice(d);if(b&&"stave"in b)for(d=0;d<this.vexflowNotes.length;d++)this.vexflowNotes[d].setStave(b.stave);this.vexflowVoice.setStrict(false).addTickables(this.vexflowNotes);return this.vexflowVoice};
a.setVexflowStave=function(c){if(this.vexflowVoice)for(var b=this.vexflowVoice.tickables,d=0;d<b.length;d++)b[d].setStave(c)};a.drawVexflow=function(c,b,d){if(this.vexflowVoice){this.vexflowVoice.draw(b,d);for(c=0;c<this.vexflowObjects.length;c++)this.vexflowObjects[c].setContext(b).draw();return true}};Vex.ML.PartStaff=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.PartStaff.prototype.init=function(c,b){this.options={};Vex.Merge(this.options,b);if(!this.options.staff_num)throw new Error("VeXML.PartStaff requires a staff_num");this.parentElement=c;this.attributes=[];this.measures=[];this.clef="clef"in this.options?this.options.clef:this.getAttributes(1).getClef()?this.getAttributes(1).getClef():undefined};
Vex.ML.PartStaff.prototype.getAttributes=function(c){if(c in this.attributes)return this.attributes[c];var b=this.parentElement.getAttributes(c),d={},e=[];for(var f in b.attributes)if(b.attributes[f]instanceof Array){if(this.options.staff_num in b.attributes[f])d[f]=b.attributes[f][this.options.staff_num]}else d[f]=b.attributes[f];for(var g=0;g<b.new_attributes.length;g++){f=b.new_attributes[g];f in d&&e.push(f)}b=Vex.ML.Attributes.createFromPrevious(b);b.attributes=d;b.new_attributes=e;return this.attributes[c]=
b};
Vex.ML.PartStaff.prototype.getMeasure=function(c,b){if(c in this.measures)return this.measures[c];var d={};if(this.getAttributes(c).getClef())d.clef=this.getAttributes(c).getClef();Vex.Merge(d,b);d=this.parentElement.getMeasure(c,d);var e=d.element.cloneNode(false);d=d.element.childNodes;for(var f=false,g=[],h=0;h<d.length;h++){var i=d[h];if(i.tagName=="note"||i.tagName=="direction"){var j=i.getElementsByTagName("staff")[0];if(j)if(parseInt(j.textContent)!=this.options.staff_num){if(i.tagName=="note"){f=
true;if(i.getElementsByTagName("chord").length==0){g=[];i=i.getElementsByTagName("beam");for(j=0;j<i.length;j++)g.push(i[j])}}}else{j=i.cloneNode(true);if(j.tagName=="note"){if(f)if(f=j.getElementsByTagName("chord")[0]){j.removeChild(f);for(i=0;i<g.length;i++)j.appendChild(g[i].cloneNode(true))}f=false}e.appendChild(j)}}else if(i.tagName=="attributes"){j=i.cloneNode(false);var l=i.childNodes;for(i=0;i<l.length;i++){var k=l[i];k.getAttribute&&k.getAttribute("number")&&parseInt(k.getAttribute("number"))!=
this.options.staff_num||j.appendChild(k.cloneNode(true))}e.appendChild(j)}else if(i.tagName=="print"){j=i.cloneNode(false);l=i.childNodes;for(i=0;i<l.length;i++){k=l[i];k.tagName=="staff-layout"&&parseInt(k.getAttribute("number"))!=c||j.appendChild(k.cloneNode(true))}e.appendChild(j)}}d={clef:this.clef};Vex.Merge(d,b);b=new Vex.ML.Measure(e,d);return this.measures[c]=b};Vex.ML.Note=function(c,b){arguments.length>0&&this.init(c,b)};Vex.ML.Note.prototype=new Vex.ML.Element;Vex.ML.Note.superclass=Vex.ML.Element;Vex.ML.Note.constructor=Vex.ML.Note;Vex.ML.Note.prototype.nodeName="note";Vex.ML.Note.type={"256th":"256","128th":"128","64th":"64","32nd":"32","16th":"16",eighth:"8",quarter:"4",half:"2",whole:"1"};Vex.ML.Note.accidentals={sharp:"#",flat:"b",natural:"n","double-sharp":"##","sharp-sharp":"##","flat-flat":"bb","-1":"b","-2":"bb","1":"#","2":"##"};a=Vex.ML.Note.prototype;
a.init=function(c,b){this.constructor.prototype.init.call(this,c,b);if(!b.measure||!(b.measure instanceof Vex.ML.Measure))throw new Error("VeXML.Note requires a VeXML.Measure");if(c=this.element.getElementsByTagName("duration")[0]){c=parseInt(c.textContent);if(isNaN(c))throw new Error("can't parse note duration");this.numTicks=b.measure.ticksPerDivision*c;this.duration="8"}else this.numTicks=0;if(b=this.element.getElementsByTagName("rest")[0]){this.rest=true;if(b.getAttribute("measure")=="yes")this.duration=
"1r";this.pitch=this.pitchToString(b);if(!this.pitch)switch("measure"in this.options?this.options.measure.clef:"treble"){case "bass":this.pitch="d/3";break;case "treble":default:this.pitch="b/4";break}}else{this.rest=false;b=this.element.getElementsByTagName("pitch")[0];if(!b)throw new Error("Non-rest <note> must have a <pitch> element");this.pitch=this.pitchToString(b)}if(b=this.element.getElementsByTagName("type")[0]){this.duration=Vex.ML.Note.type[b.textContent];if(!this.duration)throw new Error("Duration not recognized: "+
b.textContent);b=this.element.getElementsByTagName("dot");for(c=0;c<b.length;c++)this.duration+="d";this.numDots=b.length;if(this.rest)this.duration+="r"}if(!this.duration)throw new Error("Note does not have a duration");if(b=this.element.getElementsByTagName("accidental")[0])this.accidental=Vex.ML.Note.accidentals[b.textContent];if(b=this.element.getElementsByTagName("notations")[0])if(b=b.getElementsByTagName("tied")[0])this.tieType=b.getAttribute("type");this.beam=(b=this.element.getElementsByTagName("beam")[0])?
{number:parseInt(b.getAttribute("number")),type:b.textContent}:null};a.isRealNote=function(){return this.duration!=0};a.getPitches=function(){return[this.pitch]};a.getDuration=function(){return this.duration};
a.pitchToString=function(c){var b=c.getElementsByTagName("step"),d=c.getElementsByTagName("octave");alter=c.getElementsByTagName("alter");b.length||(b=c.getElementsByTagName("display-step"));d.length||(d=c.getElementsByTagName("display-octave"));if(!(b.length==0||d.length==0)){c=parseInt(d[0].textContent);c!=0&&!c&&alter.length&&parseInt(alter[0].textContent);b=b[0].textContent;if(b.length==1){b=b.toLowerCase();switch(alter){case 1:b+="#";break;case 2:b+="##";break;case -1:b+="b";break;case -2:b+=
"bb";break}b+="/"+c.toString();return b}}};Vex.ML.Chord=function(c,b){arguments.length>0&&this.init(c,b)};a=Vex.ML.Chord.prototype;a.init=function(c,b){this.pitches=c.getPitches();this.duration=c.getDuration();for(var d in c)if(c.hasOwnProperty(d)&&d!="element")this[d]=c[d];this.options={};Vex.Merge(this.options,b)};a.addNote=function(c){c=c.getPitches();for(var b=0;b<c.length;b++)this.pitches.push(c[b])};a.setPitches=function(c){this.pitches=c;return this};a.getPitches=function(){return this.pitches};a.getDuration=function(){return this.duration};Vex.ML.StaffSystem=function(c,b){arguments.length>0&&this.init(c,b)};a=Vex.ML.StaffSystem.prototype;
a.init=function(c,b){if(typeof b.width!="number"||typeof b.x!="number"||typeof b.y!="number")throw new Error("StaffSystem needs numeric x, y, and width options");this.width=b.width;this.x=b.x;this.y=b.y;this.options={start_measure:1,inter_staff_space:0};Vex.Merge(this.options,b);if(!this.options.numberOfStaves)this.options.numberOfStaves=c.getTotalStaves();this.start_measure=this.options.start_measure;this.end_measure="end_measure"in this.options&&this.options.end_measure&&this.options.end_measure>=
this.start_measure?this.options.end_measure:null;this.document=c;this.staveHeight=(new Vex.Flow.Stave(0,0,100)).getHeight();this.staves=[];this.stavesStartX=[];this.stavesEndX=[];this.voices=[];this.vexflowVoices=[];this.voiceStaves=[];this.formatters=[];this.minWidths=[];this.minActualWidths=[];this.additionalWidths=[]};a.partStaffForStaffNum=function(c){for(var b=0,d=this.document.getPartIDs(),e=0;e<d.length;e++){var f=this.document.getPart(e).getNumberOfStaves();if(b+f>c)return[e,c-b];b+=f}};
a.getPartStaff=function(c){c=this.partStaffForStaffNum(c);var b=this.document.getPart(c[0]);if(b)return b.getStaff(c[1]+1)};a.getModifierArray=function(c){for(var b=[],d=this.document.getTotalStaves(),e=0;e<d;e++){var f=this.partStaffForStaffNum(e);f=this.document.getPart(f[0]).getStaff(f[1]+1).getAttributes(c).getStaveModifiers({line_start:c==this.start_measure,start_measure:c<=1&&c==this.start_measure});b.push(f)}return b};
a.createVoicesAndFormatters=function(){var c=this.document.getPart(0).getNumberOfMeasures();if(this.end_measure&&this.end_measure>=this.start_measure)c=this.end_measure;for(var b=this.document.getPartIDs(),d=0,e=0;e<c-this.start_measure;e++){if(!(e in this.voices)){this.voices[e]=[];this.vexflowVoices[e]=[];this.voiceStaves[e]=[];this.stavesStartX[e]=[];this.stavesEndX[e]=[]}for(var f=0,g=0,h=0;h<b.length;h++){for(var i=this.document.getPart(h),j=i.getNumberOfStaves(),l=f;l<f+j;l++)for(var k=i.getStaff(l+
1-f).getMeasure(this.options.start_measure+e),n=k.getVoiceNumbers(),o=0;o<n.length;o++){var m=k.getVoice(n[o]);this.voices[e].push(m);this.vexflowVoices[e].push(m.createVexflowVoice());this.voiceStaves[e].push(l)}f+=j;g+=j}f=[];i=this.getModifierArray(this.start_measure+e);for(h=0;h<g;h++){f[h]=new Vex.Flow.Stave(0,h*100,this.width);for(j=0;j<i[h].length;j++)f[h].addModifier(i[h][j]);this.stavesStartX[e][h]=f[h].getNoteStartX();this.stavesEndX[e][h]=f[h].getNoteEndX()}i=this.stavesEndX[e][0]-this.stavesStartX[e][0];
for(h=1;h<g;h++)if(i>this.stavesEndX[e][h]-this.stavesStartX[e][h])i=this.stavesEndX[e][h]-this.stavesStartX[e][h];this.additionalWidths[e]=this.width-i;for(g=0;g<this.voices[e].length;g++)this.voices[e][g].setVexflowStave(f[this.voiceStaves[e][g]]);this.formatters[e]=(new Vex.Flow.Formatter).joinVoices(this.vexflowVoices[e]);this.formatters[e].format(this.vexflowVoices[e],i);this.minWidths[e]=this.formatters[e].getMinTotalWidth();this.formatters[e].format(this.vexflowVoices[e],this.minWidths[e]);
for(g=f=0;g<this.vexflowVoices[e].length;g++){h=this.vexflowVoices[e][g].tickables;h=h[h.length-1].getX();if(h>f)f=h}f+=30;this.minActualWidths[e]=f;g=f+this.additionalWidths[e];g=g<250?250:g;if(g+d>this.width){this.voices.splice(e,1);this.vexflowVoices.splice(e,1);this.voiceStaves.splice(e,1);if(!this.end_measure)this.end_measure=this.start_measure;break}else{d+=g;this.end_measure=this.start_measure+e}}};
a.getEndMeasure=function(){if(this.end_measure&&this.end_measure>=this.start_measure)return this.end_measure;this.createVoicesAndFormatters();return this.end_measure};
a.createStaves=function(){this.staves=[];this.connectedBarlines=[];this.connectors=[];for(var c=this.document.getPartIDs(),b=[],d=0,e=0;e<c.length;e++){b[e]=this.document.getPart(e);for(var f=b[e].getNumberOfStaves(),g=0;g<f-1;g++)this.connectedBarlines.push(d+g);f>1&&this.connectors.push({top_stave:d,bottom_stave:d+f-1,type:Vex.Flow.StaveConnector.type.BRACE});d+=f}this.getEndMeasure();c=[];for(e=g=0;e<this.voices.length;e++){c[e]=Math.ceil(this.additionalWidths[e]+this.minActualWidths[e]);g+=c[e]}if(this.width>
g){b=Math.floor((this.width-g)/c.length);for(e=0;e<c.length;e++)c[e]+=b;g+=c.length*b;c[0]+=this.width-g}b=this.x;for(e=0;e<=this.end_measure-this.start_measure;e++){this.staves[e]=[];d=this.getModifierArray(e+this.start_measure);for(g=0;g<this.options.numberOfStaves;g++){this.staves[e][g]=new Vex.Flow.Stave(b,this.y+g*(this.staveHeight+this.options.inter_staff_space),c[e]);f=this.getPartStaff(g).getMeasure(e+this.start_measure);if(f.clef)this.staves[e][g].clef=f.clef;for(f=0;f<d[g].length;f++)this.staves[e][g].addModifier(d[g][f])}b+=
c[e]}};a.getStaves=function(){if(!this.staves||!this.staves.length)this.createStaves();return this.staves};a.getHeight=function(){this.getStaves();var c=this.staves[0][this.staves[0].length-1];return c.y+c.getHeight()};
a.draw=function(c){if(!this.staves||!this.staves.length)this.createStaves();for(var b=0;b<this.staves.length;b++)for(var d=0;d<this.staves[b].length;d++){this.staves[b][d].setContext(c);this.staves[b][d].draw(c);for(var e=0;e<this.connectedBarlines.length;e++)if(this.connectedBarlines[e]==d){var f,g;if(b+1==this.staves.length){f=new Vex.Flow.Stave(this.staves[b][d].getX()+this.staves[b][d].width,this.staves[b][d].y,100);g=new Vex.Flow.Stave(this.staves[b][d+1].getX()+this.staves[b][d+1].width,this.staves[b][d+
1].y,100)}else{f=this.staves[b+1][d];g=this.staves[b+1][d+1]}f=new Vex.Flow.StaveConnector(f,g);f.setType(Vex.Flow.StaveConnector.type.SINGLE);f.setContext(c).draw()}}f=new Vex.Flow.StaveConnector(this.staves[0][0],this.staves[0][this.staves[0].length-1]);f.setType(Vex.Flow.StaveConnector.type.SINGLE);f.setContext(c);f.draw();for(b=0;b<this.connectors.length;b++){d=this.connectors[b];f=new Vex.Flow.StaveConnector(this.staves[0][d.top_stave],this.staves[0][d.bottom_stave]);f.setType(d.type).setContext(c).draw()}};
a.drawContents=function(c){this.document.getPartIDs();for(var b=0;b<this.staves.length;b++){for(var d=this.voices[b],e=this.vexflowVoices[b],f=this.staves[b],g=0;g<d.length;g++)d[g].setVexflowStave(f[this.voiceStaves[b][g]]);g=this.formatters[b];var h;if(f[0].width-this.additionalWidths[b]<=this.minActualWidths[b]+10)h=this.minWidths[b];else{h=f[0].getNoteEndX()-f[0].getNoteStartX();if(this.minActualWidths[b]>this.minWidths[b])h+=this.minWidths[b]-this.minActualWidths[b];if(h<this.minWidths[b])h=
this.minWidths[b]}g.format(e,h);for(g=0;g<d.length;g++)d[g].drawVexflow(undefined,c,f[this.voiceStaves[b][g]])}};
