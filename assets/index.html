<html>
<head>
    <title>nln-score</title>
    <script src="js/vendor/jquery-1.7.1.min.js"></script>
    <script src="js/vendor/jquery.deserialize.js"></script>
    <link href="styles/style.css" type="text/css" rel="stylesheet"/>

    <style>
        .menuItem {
            display: inline-block;
            vertical-align: top;

        }

        .instrument {
            display: block;
        }

        .roleMenu {
            display: none;
        }
    </style>
    <link rel="icon"
          type="image/ico"
          href="favicon.ico">
</head>
<body>

<div class="performanceMenu">
    Join an existing performance:<br/>
    <select class="performance menuItem">
        <option value="">Select a performance</option>
    </select><br/><br/>

    Or create a new performance:
    <form class="performance-form">
        <input type="text" name="id" placeholder="performance id"/>
        <select class="piece menuItem" name="piece">
            <option value="">Select a piece</option>
        </select>
        <input type="text" name="gameplayState" placeholder="initial gameplay state (0-7)"/>
        <input type="text" name="currentFragments" placeholder="start fragment 1"/>
        <input type="text" name="currentFragments" placeholder="start fragment 2"/>
        <select name="scoreType">
            <option value="img">Image</option>
            <option value="abc">ABC Notation</option>
            <option value="xml">MusicXML</option>
        </select>
        <button type="submit">Create</button>
    </form>

</div>

<div class="roleMenu">
    Select your role:<br/>

    <div class="menuItem conductor">
        <a href="pages/conductor.html?page=left&instrument=conductor">conductor left</a><br/>
        <a href="pages/conductor.html?page=right&instrument=conductor">conductor right</a>
    </div>
    <div class="instruments menuItem">
        <div class="instrument-title">Instrument:</div>
    </div>
    <a class="interpreter-link" href="pages/interpreter.html" class="menuItem">interpreter</a>
</div>

<script>

    $.get("performance", function (data) {
        performances = {};
        console.log('received performances', data);
        $.each(data, function () {
            performances[this.id] = this;
            addPerformanceOption(this);
        });
    });

    $.get('piece/titles', function (data) {
        console.log('received instruments', data);
        var pieceSelect = $('.piece');
        $.each(data, function () {
            var pieceOption = $('<option/>');
            pieceOption.attr('value', this.id);
            pieceOption.html(this.title);
            pieceSelect.append(pieceOption);
        });
    });

    $(".performance").change(function () {
        $(".instruments .instrument").remove();
        var performance = performances[$(this).val()];
        updateLinks(performance);
        $(".performance-form").deserialize(performance);


    });

    $(".performance-form").on("submit", function (event) {
        event.preventDefault();
        console.log($(this).serialize());
        $.post('/performance', $(this).serialize(), function (res) {
            console.log("created performance", res);
            addPerformanceOption(res);
            performances[res.id] = res;
            $('.performance').val(res.id);
            $('.performance').change();
        });
    });

    function updateLinks(performance) {
        if (performance) {
            $(".menuItem.conductor").html(
                    '<a href="pages/conductor.html?page=left&instrument=conductor&performance=' + performance.id + '&piece=' + performance.piece + '">conductor left</a><br/>' +
                            '<a href="pages/conductor.html?page=right&instrument=conductor&performance=' + performance.id + '&piece=' + performance.piece + '">conductor right</a>'
            )
            $(".interpreter-link").attr("href", "pages/interpreter.html?performance=" + performance.id)
            setInstrumentOptions(performance);
        } else {
            $('.roleMenu').hide();
            resetForm($('.performance-form'));
        }
    }

    function addPerformanceOption(performance) {
        var performanceSelect = $('.performance');
        var performanceOption = $('<option/>');
        performanceOption.html(performance.id);
        performanceOption.attr('value', performance.id);
        performanceOption.attr('data-piece', performance.piece);
        performanceSelect.append(performanceOption);
    }

    function setInstrumentOptions(performance) {
        $.get("piece/" + performance.piece, function (data) {
            if (data) {
                $('.roleMenu').show();
                console.log("received instruments", data.instruments);
                var instrumentList = $(".instruments");
                $.each(data.instruments, function (val, text) {
                    instrumentLink = $("<a/>")
                            .attr("href", "pages/instrumentalist.html?instrument=" + val +
                                    "&piece=" + performance.piece +
                                    "&performance=" + performance.id)
                            .text(text)
                            .attr("class", "instrument");
                    instrumentList.append(instrumentLink);
                });
            } else {
                $('.roleMenu').hide();
                resetForm($('.performance-form'));
            }
        });
    }

    function resetForm($form) {
        $form.find('input:text, input:password, input:file, select, textarea').val('');
        $form.find('input:radio, input:checkbox')
                .removeAttr('checked').removeAttr('selected');
    }
</script>
</body>
</html>